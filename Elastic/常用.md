## 常用

* #### ELK健康检查

    * Elasticsearch
        
        * cluster health
            ```bash
            shell> curl -XGET "127.0.0.1:9200/_cluster/health?pretty"
            {
              "cluster_name" : "testcluster",
              "status" : "yellow",
              "timed_out" : false,
              "number_of_nodes" : 1,
              "number_of_data_nodes" : 1,
              "active_primary_shards" : 5,
              "active_shards" : 5,
              "relocating_shards" : 0,
              "initializing_shards" : 0,
              "unassigned_shards" : 5,
              "delayed_unassigned_shards": 0,
              "number_of_pending_tasks" : 0,
              "number_of_in_flight_fetch": 0,
              "task_max_waiting_in_queue_millis": 0,
              "active_shards_percent_as_number": 50.0
            }
            ```
        
* #### ELK性能调优

    * Elasticsearch
        
        * 在日志文件中频繁出现`[gc][161194] overhead, spent [421ms] collecting in the last [1s]`，说明你的JVM内存配置较小
        
        * `curl -XGET "localhost:9200/_cat/nodes?v"`，查看所有的Node的负载状况
        （磁盘、CPU、Heap、内存、file_desc、indexing、merges、get、flush、search等）
            
            你可以指定查询某几列监控数据：
            ```bash
            shell> curl -XGET "localhost:9200/_cat/nodes?v&h=id,ip,port,v,m"
            shell> curl -XGET "localhost:9200/_cat/nodes?v&h=ip,get.*"
            ```
            
            > 注：上述命令中的URL地址需要用`引号`包起来，因为`&`是特殊字符。`h=`后面的列明可以使用通配符，
            如：`h=get.*`。[详细列明文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-nodes.html)
        
        * 查看正在等待执行任务（pending_tasks）
            
            * `curl -XGET "localhost:9200/_cat/pending_tasks?v"`
            * `curl -XGET "localhost:9200/_cluster/pending_tasks"`
        
        * 查看线程池执行的状态，[官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-thread-pool.html)
        
            * `curl -XGET "localhost:9200/_cat/thread_pool?v"` : 显示所有Node所有线程池的状态（active、queue、rejected）
            * `curl -XGET "localhost:9200/_cat/thread_pool/bulk?v"` : 显示bulk线程池的状态
            * `curl -XGET "localhost:9200/_cat/thread_pool?v&h=id,name,active,rejected,completed"` : 显示特定列
        
        * 返回Cluster综合信息（nodes、templates、indices、index-graveyard、routing_table、routing_nodes），
        [官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-state.html)
            
            * `curl -XGET "localhost:9200/_cluster/state?pretty"`
            
        * 返回Cluster统计信息，[官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-stats.html)
        
            * `curl -XGET "localhost:9200/_cluster/stats?human&pretty"`
            
        * 针对Node全方位统计信息，[官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-stats.html)
        
            * `curl -X GET "localhost:9200/_nodes/stats?pretty"`
            * `curl -X GET "localhost:9200/_nodes/nodeId1,nodeId2/stats?pretty"`
            
        * Node信息，[官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-info.html)

            * `curl -X GET "localhost:9200/_nodes?pretty"`
            * `curl -X GET "localhost:9200/_nodes/nodeId1,nodeId2?pretty"`
            
        * 返回当前正在执行的Task，[官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/tasks.html)
        
            * `curl -X GET "localhost:9200/_tasks?pretty"`
            * `curl -X GET "localhost:9200/_tasks?nodes=nodeId1,nodeId2&pretty"`
            * `curl -X GET "localhost:9200/_tasks?nodes=nodeId1,nodeId2&actions=cluster:*&pretty"`
            
        * 查看`hot_threads`，[官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-hot-threads.html)
        
            * `curl -X GET "localhost:9200/_nodes/hot_threads"`
            * `curl -X GET "localhost:9200/_nodes/{nodesIds}/hot_threads"`
            
    * Logstash
    
        * 查看Node信息：`curl -XGET 'localhost:9600/_node?pretty'`，[官方文档](https://www.elastic.co/guide/en/logstash/current/node-info-api.html)
        
        * 查看Node统计信息，[官方文档](https://www.elastic.co/guide/en/logstash/current/node-stats-api.html)
            
            * `curl -XGET 'localhost:9600/_node/stats?pretty'` ： 显示所有统计信息
                
                > 注：最主要是查看`pipelines`下面的`events`/`outputs`/`queue`三项数据
                
                1. `events`可以对比`in`/`filtered`/`out`三项数据就知道压力落在哪一项上
                2. `outputs`对比`in`/`out`，如果`in`一直大于`out`，说明`out`端压力较大
                3. 查看`queue/events`数据大小，如果数据较大，说明Logstash压力就大，数据处理不过来，导致一直堆在队列中
            
            * `curl -XGET 'localhost:9600/_node/stats/jvm?pretty'` ：只返回JVM统计信息
    
        * 查看`hot_threads`：`curl -XGET 'localhost:9600/_node/hot_threads?pretty'`，[官方文档](https://www.elastic.co/guide/en/logstash/current/hot-threads-api.html)
        
    * FileBeat
            
        * 查看`/data/filebeat/registry`（依据配置文件）文件内容，看监控文件的`timestamp`和`offset`有没有实时更新
        
* #### Rolling upgrades ES [官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/rolling-upgrades.html)：因为停掉一个ES节点后，他的分片数据会转移到其他节点上，这会浪费很大的性能和时间
    
    通过下面的命令禁用和启动`shard allocation`:

    ```bash
    curl -XPUT "localhost:9200/_cluster/settings" -H 'Content-Type: application/json' -d'
    {
      "persistent": {
        "cluster.routing.allocation.enable": "none"
      }
    }
    '
    ```
        
    ```bash
    curl -X PUT "localhost:9200/_cluster/settings" -H 'Content-Type: application/json' -d'
    {
      "persistent": {
        "cluster.routing.allocation.enable": null
      }
    }
    '
    ```
    
    > 注：需等待集群状态变成`green`时，才可操作下一个Node

* #### FileBeat日志：`ERR Failed to publish events caused by: write tcp xxxxxxxx write: connection reset by peer`
    FileBeat经常出现上述错误日志，则可通过修改`file-beat-input`配置项`client_inactivity_timeout`来减少此错误，
    此错误日志不影响功能：
    
    ```
    input {
    
      beats {
        port => 5044
        client_inactivity_timeout => 120    #默认为60秒
      }
      
    }
    ```

* #### 动态修改Logstash日志级别，方便调试使用

    > [官方链接](https://www.elastic.co/guide/en/logstash/5.6/logging.html#_logging_apis)
    
    ```bash
    curl -XPUT '127.0.0.1:9600/_node/logging?pretty' -H 'Content-Type: application/json' -d'
    {
        "logger.logstash.outputs.elasticsearch" : "DEBUG"
    }
    '
    ```
    
    ```bash
    curl -XPUT '127.0.0.1:9600/_node/logging?pretty' -H 'Content-Type: application/json' -d'
    {
        "logger.logstash.outputs" : "DEBUG"
    }
    '
    ```
    
    上述属于临时配置，重启后就会失效。想配置一直有效，则在`log4j2.properties`配置文件下增加下面配置：
    ```
    logger.elasticsearch_output.name = logstash.outputs.elasticsearch
    logger.elasticsearch_output.level = debug
    ```
    
    查看所有日记级别可配项：
    ```bash
    curl -XGET '127.0.0.1:9600/_node/logging?pretty'
    ```
    
* #### 自动加载更新后的Logstash config file

    如果你想实时调整Config File中的Input/Filter/Output，有两种方案：
    
    * 在`logstash.yml`或Logstash启动命令中启用`config.reload.automatic`配置
    * 发送一个SIGHUP (signal hangup) 信号给Logstash进程，让Logstash重启`pipeline`：`kill -1 14175`
    
    
